(function(a,c){typeof exports=="object"&&typeof module<"u"?c(exports):typeof define=="function"&&define.amd?define(["exports"],c):(a=typeof globalThis<"u"?globalThis:a||self,c(a["game-doctor"]={}))})(this,function(a){"use strict";var C=Object.defineProperty;var F=(a,c,h)=>c in a?C(a,c,{enumerable:!0,configurable:!0,writable:!0,value:h}):a[c]=h;var l=(a,c,h)=>(F(a,typeof c!="symbol"?c+"":c,h),h);function c(n,e){for(const t in e)!e[t]||typeof e[t]=="function"||(n[t]=e[t]);return n}function h(n){try{const e={};for(const t in n)n[t]&&(e[t]=n[t]);return JSON.parse(JSON.stringify(e))}catch(e){throw e}}function _(){return{reportId:Math.random().toString(16).slice(2),date:new Date().toISOString(),timezone:new Date().getTimezoneOffset()}}function v(){try{const n=c({},performance);return n.eventCounts={},c(n.eventCounts,performance.eventCounts),n.memory={},c(n.memory,performance.memory||console.memory||{}),h(n)}catch(n){return{error:n}}}async function u(n){try{const e=c({},navigator.connection);try{const o=await(await fetch("https://api.ipify.org/?format=json")).json();e.ipAddress=o.ip}catch(t){e.ipAddress={error:t}}if(n)try{const t=performance.now(),o=new Image;await new Promise(r=>{o.onload=r,o.onerror=r,o.src=n}),e.ping=performance.now()-t}catch(t){e.ping={error:t}}return h(e)}catch(e){return{error:e}}}function I(){try{return{innerWidth:window.innerWidth,innerHeight:window.innerHeight,pixelRatio:window.devicePixelRatio,href:window.location.href,title:window.document.title,isEmbedded:window.top!==window.self,referrer:document.referrer}}catch(n){return{error:n}}}function w(){try{return{language:navigator.language,languages:navigator.languages,userAgent:navigator.userAgent,deviceMemory:navigator.deviceMemory||-1,doNotTrack:navigator.doNotTrack,hardwareConcurrency:navigator.hardwareConcurrency||-1,maxTouchPoints:navigator.maxTouchPoints||0}}catch(n){return{error:n}}}function y(){try{const e=document.createElement("canvas").getContext("webgl");if(!e)return{error:new Error("Unable to get WebGL context.")};const t=e.getExtension("WEBGL_debug_renderer_info");return{renderer:e.getParameter(e.RENDERER),rendererUnmasked:t&&e.getParameter(t.UNMASKED_RENDERER_WEBGL),vendor:e.getParameter(e.VENDOR),vendorUnmasked:t&&e.getParameter(t.UNMASKED_VENDOR_WEBGL)}}catch(n){return{error:n}}}async function E(n,e){try{const t=document.createElement("canvas"),o=Math.min(512/t.width,512/t.height);t.width=t.width*o,t.height=t.height*o;const r=t.getContext("2d");return e&&await e(),r.drawImage(n,0,0,t.width,t.height),t.toDataURL("image/jpeg",65)}catch(t){return{error:t}}}function k(){try{return new Promise((n,e)=>{navigator.geolocation.getCurrentPosition(t=>n(h(t.coords)),t=>e({error:t}),{enableHighAccuracy:!0,timeout:5e3,maximumAge:0})})}catch(n){return{error:n}}}async function T(n={}){try{const t=new TextEncoder().encode(JSON.stringify({...w(),...y(),...u(),additionalInfo:n})),o=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(o)).map(s=>s.toString(16).padStart(2,"0")).join("")}catch(e){return{error:e}}}function R(n=20){window.__frameTime=0;let e=performance.now();return()=>{const o=performance.now()-e;window.__frameTime+=(o-window.__frameTime)/n,e=performance.now()}}function p(){try{return window.__frameTime===void 0?-1:(1e3/window.__frameTime).toFixed(1)}catch(n){return{error:n}}}class b{constructor(e){l(this,"_options");l(this,"_lastError");l(this,"onTick");l(this,"_fpsTickInterval");l(this,"_fpsEl");var t,o,r;if(this._options=e,this.onTick=R(),((t=this._options.reports)==null?void 0:t.lastError)!==!1&&(window.onerror=(s,i,f)=>{this._lastError=[s,i,f]}),this._options.attachToWindow&&(window.__generateReport=this.generateReport.bind(this),window.__toggleFps=this.showFps.call(this,this._fpsEl)),(o=this._options.keyboardShortcuts)!=null&&o.generateReport){const s=this._options.keyboardShortcuts.generateReport;window.addEventListener("keydown",i=>{if(i.key.toLowerCase()===s.key.toLowerCase()){if(s.altKey&&!i.altKey||s.ctrlKey&&!i.ctrlKey||s.shiftKey&&!i.shiftKey||s.metaKey&&!i.metaKey)return;this.generateReport()}})}if((r=this._options.keyboardShortcuts)!=null&&r.toggleFps){const s=this._options.keyboardShortcuts.toggleFps;window.addEventListener("keydown",i=>{if(i.key.toLowerCase()===s.key.toLowerCase()){if(s.altKey&&!i.altKey||s.ctrlKey&&!i.ctrlKey||s.shiftKey&&!i.shiftKey||s.metaKey&&!i.metaKey)return;this.showFps(!this._fpsEl)}})}}showFps(e=!0){if(!(e&&this._fpsEl))if(e){const t=document.createElement("div");t.style.position="fixed",t.style.top="0",t.style.right="0",t.style.zIndex=Number.MAX_SAFE_INTEGER.toString(),t.style.backgroundColor="#000",t.style.color="#fff",t.style.fontFamily="monospace",t.style.fontSize="12px",t.style.padding="5px";const o=p();t.innerHTML=`FPS: ${o}`,this._fpsEl=t,document.body.appendChild(t),clearInterval(this._fpsTickInterval),this._fpsTickInterval=setInterval(()=>{if(!this._fpsEl)return;const r=p();this._fpsEl.innerHTML=`FPS: ${r}`},1e3)}else this._fpsEl&&(document.body.removeChild(this._fpsEl),this._fpsEl=void 0),clearInterval(this._fpsTickInterval)}hideFps(){this.showFps(!1)}setFingerprintInfo(e){this._options.additionalFingerprintInfo=e}async getFingerprint(){return await T(this._options.additionalFingerprintInfo)}async generateReport(){const e=this._options.getAdditionalInfo?await this._options.getAdditionalInfo():{},t={..._(),gameName:this._options.gameName,gameVersion:this._options.gameVersion,additionalInfo:e},o=this._options.reports||{};if(o.performance!==!1&&(t.performance=v()),o.network!==!1&&(t.network=await u(this._options.pingUrl)),o.window!==!1&&(t.window=I()),o.device!==!1&&(t.device=w()),o.graphicsDevice!==!1&&(t.graphicsDevice=y()),o.screenshot!==!1){if(!this._options.canvasEl)throw new Error("No canvas element provided for screenshot.");t.screenshot=await E(this._options.canvasEl,this._options.canvasRenderFn)}o.location&&(t.location=await k()),o.fingerprint!==!1&&(t.fingerprint=await this.getFingerprint()),o.fps!==!1&&(t.fps=p()),o.lastError!==!1&&(t.lastError=this._lastError);const r=JSON.stringify(t),s=btoa(r);if(this._options.outputToConsole&&(console.log("=== Game Doctor Diagnostic Report ==="),console.log(JSON.stringify(JSON.parse(r),null,4)),console.log("=== End of Report ===")),this._options.outputFormat==="image/png"){const i=this._encodeReportAsImage(t.reportId,s),f=i.toDataURL("image/png"),d=await new Promise(g=>{i.toBlob(S=>g(S),"image/png")});return this._options.copyToClipboard&&navigator.clipboard.write([new ClipboardItem({"image/png":d})]),f}else{const i=this._options.outputFormat==="base64"?s:r;return this._options.copyToClipboard&&navigator.clipboard.writeText(i),i}}static decodeBase64(e){return JSON.parse(atob(e))}_encodeReportAsImage(e,t){const o=document.createElement("canvas"),r=o.getContext("2d");o.width=Math.ceil(Math.sqrt(t.length)),o.height=o.width;let s;this._options.overlayImage&&(r.drawImage(this._options.overlayImage,0,0,o.width,o.height),s=r.getImageData(0,0,o.width,o.height)),o.width=Math.ceil(Math.sqrt(t.length)),o.height=o.width,r.fillStyle="#000",r.fillRect(0,0,o.width,o.height),r.font="12px monospace",r.fillStyle="#f00",r.fillText(e,5,15);const i=r.getImageData(0,0,o.width,o.height),f=i.data;for(let d=0;d<t.length;d++){const g=d%o.width,m=(Math.floor(d/o.width)*o.width+g)*4,D=t[d].charCodeAt(0);f[m+1]=s?s.data[m+1]:0,f[m+2]=D,f[m+3]=255}return r.putImageData(i,0,0),o}static async decodeImageUrl(e){const t=new Image;t.src=e,await new Promise(d=>{t.onload=d});const o=document.createElement("canvas");o.width=t.width,o.height=t.height;const r=o.getContext("2d");r.drawImage(t,0,0);const i=r.getImageData(0,0,o.width,o.height).data;let f="";for(let d=0;d<i.length;d+=4){const g=i[d+2];if(g===0)break;f+=String.fromCharCode(g)}return this.decodeBase64(f)}static async decodeImage(e){const t=document.createElement("canvas");return t.width=e.width,t.height=e.height,t.getContext("2d").drawImage(e,0,0),await this.decodeImageUrl(t.toDataURL("image/png"))}}a.GameDoctor=b,a.getDeviceInformation=w,a.getFingerprint=T,a.getFps=p,a.getGraphicsDeviceInformation=y,a.getInformation=_,a.getLocation=k,a.getNetworkInformation=u,a.getPerformanceInformation=v,a.getScreenshot=E,a.getWindowInformation=I,a.trackFps=R,Object.defineProperty(a,Symbol.toStringTag,{value:"Module"})});
